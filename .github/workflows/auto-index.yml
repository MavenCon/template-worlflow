name: Generate Maven Repository Index

permissions:
  contents: write

on:
  push:
    branches: [ main ]
    paths:
      - 'releases/**'  # 只有当目录内容变化时才触发
      - 'snapshots/**'
      - 'plugins/**'
  workflow_dispatch:     # 允许手动触发

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录，可能需要用于版本比较

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Maven Indexer
        run: |
          # 下载最新版indexer-cli
          INDEXER_VERSION=$(curl -s https://repo.maven.apache.org/maven2/org/apache/maven/indexer/indexer-cli/maven-metadata.xml | grep -oP '(?<=<latest>)[^<]+')
          wget https://repo.maven.apache.org/maven2/org/apache/maven/indexer/indexer-cli/${INDEXER_VERSION}/indexer-cli-${INDEXER_VERSION}-cli.jar -O indexer-cli.jar
          echo "使用 indexer-cli 版本: ${INDEXER_VERSION}"

      - name: Generate index
        run: |
          # 先清理索引目录，防止残留文件导致冲突
          rm -rf releases/.index snapshots/.index plugins/.index
          mkdir -p releases/.index
          mkdir -p snapshots/.index
          mkdir -p plugins/.index
          
          # 生成索引（不要提前创建属性文件）
          java -jar indexer-cli.jar \
            -c \
            -i ./snapshots/.index \
            -n github-snapshots-repo \
            -r snapshots
          
          # 生成属性文件
          cat <<EOF > ./releases/.index/nexus-maven-repository-index.properties
          #Nexus Index Properties
          version=1
          incremental=false
          repositoryId=github-releases-repo
          timestamp=$(date +%s000)
          description=Maven repository hosted on GitHub
          EOF
          
          cat <<EOF > ./snapshots/.index/nexus-maven-repository-index.properties
          #Nexus Index Properties
          version=1
          incremental=false
          repositoryId=github-snapshots-repo
          timestamp=$(date +%s000)
          description=Maven repository hosted on GitHub
          EOF
          
          cat <<EOF > ./plugins/.index/nexus-maven-repository-index.properties
          #Nexus Index Properties
          version=1
          incremental=false
          repositoryId=github-plugins-repo
          timestamp=$(date +%s000)
          description=Maven repository hosted on GitHub
          EOF

          du -sh ./releases/.index
          du -sh ./snapshots/.index
          du -sh ./plugins/.index

      - name: Generate HTML index
        run: |
          REPOS=("releases" "snapshots" "plugins")
          REPO_TITLES=("Release" "Snapshot" "Plugin")
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
          REPO_OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          
          # 创建通用 CSS 样式文件
          cat > style.css << EOF
          body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #24292e;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
          }
          h1 { 
            border-bottom: 1px solid #eaecef;
            padding-bottom: 10px;
            margin-top: 0;
            color: #24292e;
          }
          .container {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
          }
          pre {
            background-color: #f1f1f1;
            border-radius: 3px;
            padding: 10px;
            overflow-x: auto;
          }
          code {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
          }
          .repository-list {
            list-style-type: none;
            padding-left: 0;
          }
          .repository-list li {
            padding: 10px;
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            margin-bottom: 10px;
          }
          .repository-list li a {
            color: #0366d6;
            text-decoration: none;
            font-weight: bold;
          }
          .repository-list li a:hover {
            text-decoration: underline;
          }
          .footer {
            margin-top: 30px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eaecef;
            padding-top: 10px;
          }
          EOF
          
          # 生成子仓库索引页面
          for i in "${!REPOS[@]}"; do
            repo="${REPOS[$i]}"
            title="${REPO_TITLES[$i]}"
          
            cat > ./$repo/index.html << EOF
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Maven 仓库 - $title</title>
            <link rel="stylesheet" href="../style.css">
          </head>
          <body>
            <h1>Maven 仓库 - $title</h1>
            <div class="container">
              <p>这是一个 Maven 仓库。要在您的 Maven 项目中使用它，请将以下内容添加到您的 pom.xml 中：</p>
              <pre><code>&lt;repositories&gt;
            &lt;repository&gt;
              &lt;id&gt;github-$repo-repo&lt;/id&gt;
              &lt;name&gt;GitHub Maven Repository - $title&lt;/name&gt;
              &lt;url&gt;https://$REPO_OWNER.github.io/$REPO_NAME/$repo&lt;/url&gt;
            &lt;/repository&gt;
          &lt;/repositories&gt;</code></pre>
            </div>
            <p><a href="../">返回主页</a></p>
            <div class="footer">
              最后更新时间: $TIMESTAMP
            </div>
          </body>
          </html>
          EOF
          done
          
          # 生成主页
          cat > ./index.html << EOF
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Maven 仓库索引</title>
            <link rel="stylesheet" href="style.css">
          </head>
          <body>
            <h1>Maven 仓库索引</h1>
            <div class="container">
              <p>这是一个托管在 GitHub Pages 上的 Maven 仓库。选择下面的仓库类型进行访问：</p>
              <ul class="repository-list">
                <li><a href="./releases/">Release</li>
                <li><a href="./snapshots/">Snapshot</li>
                <li><a href="./plugins/">Plugins</li>
              </ul>
            </div>
            <div class="footer">
              最后更新时间: $TIMESTAMP
            </div>
          </body>
          </html>
          EOF

      - name: Commit and push index
        run: |
          # 配置git用户
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查是否有索引文件变化
          git add releases/.index snapshots/.index plugins/.index
          git add releases/index.html snapshots/index.html plugins/index.html
          git add index.html style.css
          
          if ! git diff --cached --quiet; then
            git commit -m "Update Maven repository index [skip ci]"
            git push
          else
            echo "No changes in index files"
          fi
